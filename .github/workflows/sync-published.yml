name: Sync Published Articles

on:
  push:
    branches: ["main"]
    paths:
      - "_posts/**"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Checkout news collector
        uses: actions/checkout@v4
        with:
          repository: cortega26/noticiencias_news_collector
          path: collector

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install collector dependencies
        run: pip install --require-hashes -r collector/requirements.lock

      - name: Collect changed posts
        id: posts
        run: |
          set -euo pipefail
          changed=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" -- "_posts/*.md" || true)
          echo "changed=$changed" >> "$GITHUB_OUTPUT"

      - name: Validate collector DB secrets
        if: steps.posts.outputs.changed != ''
        env:
          NEWS_COLLECTOR_DB_DRIVER: ${{ secrets.NEWS_COLLECTOR_DB_DRIVER }}
          NEWS_COLLECTOR_DB_HOST: ${{ secrets.NEWS_COLLECTOR_DB_HOST }}
          NEWS_COLLECTOR_DB_PORT: ${{ secrets.NEWS_COLLECTOR_DB_PORT }}
          NEWS_COLLECTOR_DB_NAME: ${{ secrets.NEWS_COLLECTOR_DB_NAME }}
          NEWS_COLLECTOR_DB_USER: ${{ secrets.NEWS_COLLECTOR_DB_USER }}
          NEWS_COLLECTOR_DB_PASSWORD: ${{ secrets.NEWS_COLLECTOR_DB_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${NEWS_COLLECTOR_DB_DRIVER:-}" ]; then
            echo "Missing NEWS_COLLECTOR_DB_DRIVER secret."
            exit 1
          fi
          if [ "${NEWS_COLLECTOR_DB_DRIVER}" = "sqlite" ]; then
            echo "Refusing to run with sqlite in CI. Set NEWS_COLLECTOR_DB_DRIVER to postgresql."
            exit 1
          fi
          missing=()
          for var in NEWS_COLLECTOR_DB_HOST NEWS_COLLECTOR_DB_PORT NEWS_COLLECTOR_DB_NAME NEWS_COLLECTOR_DB_USER NEWS_COLLECTOR_DB_PASSWORD; do
            if [ -z "${!var:-}" ]; then
              missing+=("$var")
            fi
          done
          if [ "${#missing[@]}" -ne 0 ]; then
            echo "Missing required DB secrets: ${missing[*]}"
            exit 1
          fi

      - name: Mark published in collector DB
        if: steps.posts.outputs.changed != ''
        env:
          NOTICIENCIAS__DATABASE__DRIVER: ${{ secrets.NEWS_COLLECTOR_DB_DRIVER }}
          NOTICIENCIAS__DATABASE__HOST: ${{ secrets.NEWS_COLLECTOR_DB_HOST }}
          NOTICIENCIAS__DATABASE__PORT: ${{ secrets.NEWS_COLLECTOR_DB_PORT }}
          NOTICIENCIAS__DATABASE__NAME: ${{ secrets.NEWS_COLLECTOR_DB_NAME }}
          NOTICIENCIAS__DATABASE__USER: ${{ secrets.NEWS_COLLECTOR_DB_USER }}
          NOTICIENCIAS__DATABASE__PASSWORD: ${{ secrets.NEWS_COLLECTOR_DB_PASSWORD }}
          NOTICIENCIAS__DATABASE__SSLMODE: ${{ secrets.NEWS_COLLECTOR_DB_SSLMODE }}
        run: |
          set -euo pipefail
          args=$(printf '%s\n' "${{ steps.posts.outputs.changed }}" | sed 's/^/--post /')
          python collector/scripts/mark_published.py --site-url "https://noticiencias.com" ${args}
