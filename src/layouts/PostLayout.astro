---
import BaseLayout from './BaseLayout.astro';
import { type CollectionEntry } from 'astro:content';
import WhyTrustUs from '~/components/common/WhyTrustUs.astro';

interface Props {
  post: CollectionEntry<'posts'>;
  headings: { depth: number; slug: string; text: string }[];
}

const { post, headings } = Astro.props;
const { title, excerpt: description, date, author, image, tags, categories, confidence, series } = post.data;

// Logic for Confidence Badge
const confidenceMap = {
  alta: { color: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300', label: 'Evidencia Robusta', icon: 'tabler:check' },
  media: { color: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300', label: 'Evidencia Preliminar', icon: 'tabler:alert-circle' },
  baja: { color: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300', label: 'Faltan Datos / Debate', icon: 'tabler:help' },
};
// Safe access to confidence
const confidenceBadge = confidence && confidenceMap[confidence.toLowerCase()] ? confidenceMap[confidence.toLowerCase()] : null;

// Estimated reading time (rude approximation)
const readingTime = Math.ceil(post.body.split(/\s+/).length / 200);

const schema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  "headline": title.substring(0, 110),
  "image": [image],
  "datePublished": date.toISOString(),
  "dateModified": date.toISOString(), // Should be modified time if available
  "author": [{
      "@type": "Person",
      "name": author,
      "url": "https://noticiencias.com/nosotros/"
  }]
});
---

<BaseLayout title={title} description={description} image={image}>
    <script type="application/ld+json" set:html={schema}></script>
    <article class="post">
        <header>

            <div class="meta flex flex-wrap gap-4 items-center">
                <span class="category">{categories?.[0]}</span> • 
                <span class="date">{date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</span> • 
                <span class="reading-time">{readingTime} min de lectura</span>
                
                {confidenceBadge && (
                    <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${confidenceBadge.color}`}>
                       {confidenceBadge.label}
                    </span>
                )}
            </div>

            {series && (
                <div class="inline-block mt-4 mb-2">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300 border border-purple-200 dark:border-purple-800">
                        Serie: {series}
                    </span>
                </div>
            )}

            <h1>{title}</h1>
            {image && <img src={image} alt={post.data.image_alt || title} style="max-width:100%; height:auto;" />}
            <div class="author">
              Por <a href="/nosotros" class="hover:underline font-bold">{author}</a>
            </div>
        </header>
        
        <div class="content-wrapper">
            {headings.length > 0 && (
                <aside class="toc">
                    <h3>En esta página</h3>
                    <ul>
                        {headings.filter(h => h.depth <= 3).map(h => (
                            <li class={`depth-${h.depth}`}>
                                <a href={`#${h.slug}`}>{h.text}</a>
                            </li>
                        ))}
                    </ul>
                </aside>
            )}
            
            <div class="content">
                <slot />
                <hr class="my-8 border-gray-200 dark:border-gray-700" />
                <WhyTrustUs />
            </div>
        </div>

        <footer>
            <div class="tags">
                {tags.map(tag => <span class="tag">#{tag}</span>)}
            </div>
        </footer>
    </article>
</BaseLayout>

<style>
    .post header { margin-bottom: 2rem; }
    .meta { font-size: 0.9rem; color: #666; text-transform: uppercase; letter-spacing: 0.05em; }
    .toc { background: #f9f9f9; padding: 1rem; margin-bottom: 2rem; border-left: 4px solid #ddd; }
    .toc ul { list-style: none; padding: 0; }
    .toc li { margin-bottom: 0.5rem; }
    .toc .depth-3 { margin-left: 1rem; font-size: 0.9em; }
    .tags { margin-top: 2rem; }
    .tag { background: #eee; padding: 0.2rem 0.6rem; border-radius: 4px; margin-right: 0.5rem; font-size: 0.85rem; }
    
    @media (min-width: 768px) {
        .content-wrapper { display: grid; grid-template-columns: 200px 1fr; gap: 2rem; }
        .toc { position: sticky; top: 1rem; align-self: start; }
    }
</style>
