---
import BaseLayout from './BaseLayout.astro';
import { type CollectionEntry } from 'astro:content';
import WhyTrustUs from '~/components/common/WhyTrustUs.astro';

interface Props {
  post: CollectionEntry<'posts'>;
  headings: { depth: number; slug: string; text: string }[];
}

const { post, headings } = Astro.props;
const { title, excerpt: description, date, author, image, tags, categories } = post.data;

// Estimated reading time (rude approximation)
const readingTime = Math.ceil(post.body.split(/\s+/).length / 200);

const schema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  "headline": title.substring(0, 110),
  "image": [image],
  "datePublished": date.toISOString(),
  "dateModified": date.toISOString(), // Should be modified time if available
  "author": [{
      "@type": "Person",
      "name": author,
      "url": "https://noticiencias.com/nosotros/"
  }]
});
---

<BaseLayout title={title} description={description} image={image}>
    <script type="application/ld+json" set:html={schema}></script>
    <article class="post">
        <header>
            <div class="meta">
                <span class="category">{categories?.[0]}</span> • 
                <span class="date">{date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</span> • 
                <span class="reading-time">{readingTime} min de lectura</span>
            </div>
            <h1>{title}</h1>
            {image && <img src={image} alt={post.data.image_alt || title} style="max-width:100%; height:auto;" />}
            <div class="author">Por <strong>{author}</strong></div>
        </header>
        
        <div class="content-wrapper">
            {headings.length > 0 && (
                <aside class="toc">
                    <h3>En esta página</h3>
                    <ul>
                        {headings.filter(h => h.depth <= 3).map(h => (
                            <li class={`depth-${h.depth}`}>
                                <a href={`#${h.slug}`}>{h.text}</a>
                            </li>
                        ))}
                    </ul>
                </aside>
            )}
            
            <div class="content">
                <slot />
                <hr class="my-8 border-gray-200 dark:border-gray-700" />
                <WhyTrustUs />
            </div>
        </div>

        <footer>
            <div class="tags">
                {tags.map(tag => <span class="tag">#{tag}</span>)}
            </div>
        </footer>
    </article>
</BaseLayout>

<style>
    .post header { margin-bottom: 2rem; }
    .meta { font-size: 0.9rem; color: #666; text-transform: uppercase; letter-spacing: 0.05em; }
    .toc { background: #f9f9f9; padding: 1rem; margin-bottom: 2rem; border-left: 4px solid #ddd; }
    .toc ul { list-style: none; padding: 0; }
    .toc li { margin-bottom: 0.5rem; }
    .toc .depth-3 { margin-left: 1rem; font-size: 0.9em; }
    .tags { margin-top: 2rem; }
    .tag { background: #eee; padding: 0.2rem 0.6rem; border-radius: 4px; margin-right: 0.5rem; font-size: 0.85rem; }
    
    @media (min-width: 768px) {
        .content-wrapper { display: grid; grid-template-columns: 200px 1fr; gap: 2rem; }
        .toc { position: sticky; top: 1rem; align-self: start; }
    }
</style>
