---
import { getCollection } from 'astro:content';
import BaseLayout from '~/layouts/BaseLayout.astro';
import SinglePost from '~/components/template/blog/SinglePost.astro';
import ToBlogLink from '~/components/template/blog/ToBlogLink.astro';
import { getPermalink } from '~/utils/permalinks';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => {
    // Standardize slug generation to match getPermalink behavior
    // If frontmatter permalink exists, use it (stripping lead/trail slashes)
    // Otherwise use the clean slug (no 'posts/' prefix unless that's what we want)
    const slug = post.data.permalink 
        ? post.data.permalink.replace(/^\/|\/$/g, '') 
        : `/${post.slug}`; // Changed: remove 'posts/' prefix to match root-level generation seen in dist
        
    return {
      params: { slug: slug.replace(/^\//, '') }, // Ensure no leading slash in params
      props: { post },
    };
  });
}

import ArticleSidebar from '~/components/template/blog/ArticleSidebar.astro';

// ... (existing helper logic)

const { post } = Astro.props;
const { Content } = await post.render();

const metadata = {
  title: post.data.title,
  description: post.data.excerpt,
  image: post.data.image,
  canonical: post.data.permalink ? undefined : getPermalink(post.slug, 'post'),
};
---

<BaseLayout metadata={metadata}>
  <div class="container mx-auto px-0 sm:px-4">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
      <main class="lg:col-span-8">
        <SinglePost post={{
            ...post,
            category: post.data.categories?.[0]
              ? { slug: post.data.categories[0], title: post.data.categories[0] }
              : undefined
          }} 
          url={post.data.permalink || getPermalink(post.slug, 'post')}>
          {post.data.image ? (
            <img slot="image" src={post.data.image} alt={post.data.image_alt || ""} class="w-full h-auto rounded-lg shadow-lg mb-6" />
          ) : (
            <div slot="image" class="h-10"></div>
          )}
          
          <Content />
        </SinglePost>
      </main>
      
      <aside class="hidden lg:block lg:col-span-4">
        <ArticleSidebar />
      </aside>
    </div>
  </div>

  <ToBlogLink />
</BaseLayout>
