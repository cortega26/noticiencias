---
import Image from '~/components/template/common/Image.astro';
import TopicBadge from '~/components/ds/atoms/TopicBadge.astro';
import { getPermalink } from '~/utils/permalinks';
import { getFormattedDate } from '~/utils/utils';
import { findImage } from '~/utils/images';
import type { Post } from '~/types';

interface Props {
  posts: Post[];
}

const { posts } = Astro.props;

// Ensure we have at least 1 post, ideally 3
const mainPost = posts[0];
const subPosts = posts.slice(1, 3);

const mainPostImage = mainPost ? await findImage(mainPost.image) : undefined;
const subPostsWithImages = await Promise.all(
  subPosts.map(async (post) => ({
    ...post,
    image: await findImage(post.image),
  }))
);
---

<div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-12">
  {/* Main Lead Story (Left, 8 cols) - Modern "Cover" Layout */}
  {mainPost && (
    <div class="lg:col-span-8 group relative flex flex-col h-full rounded-2xl overflow-hidden bg-white dark:bg-slate-900 shadow-sm border border-border">
      <a href={getPermalink(mainPost.permalink, 'post')} class="block relative w-full h-full overflow-hidden">
        {mainPostImage ? (
            typeof mainPostImage === 'string' ? (
                <img 
                  src={mainPostImage} 
                  alt={mainPost.title} 
                  class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-110" 
                  loading="eager"
                  fetchpriority="high"
                />
            ) : (
                <Image 
                  src={mainPostImage} 
                  alt={mainPost.title} 
                  width={1200} 
                  height={800} 
                  class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-110"
                  loading="eager"
                  fetchpriority="high"
                  sizes="(max-width: 1024px) 100vw, 800px"
                />
            )
        ) : (
            <div class="absolute inset-0 bg-surface-highlight flex items-center justify-center">
                <span class="text-gray-300 dark:text-gray-700">Sin Imagen</span>
            </div>
        )}
        
        {/* Gradient Overlay for Text Readability */}
        <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent pointer-events-none"></div>

        {/* Content Overlay - Glassmorphism Bottom Left */}
        <div class="absolute bottom-0 left-0 w-full p-6 md:p-8 flex flex-col justify-end">
             <div class="transform transition-transform duration-300 group-hover:-translate-y-2">
                 <div class="mb-3">
                    {mainPost.category && (
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-indigo-500/20 text-indigo-100 backdrop-blur-md border border-indigo-500/30">
                            {mainPost.category.title}
                        </span>
                    )}
                 </div>
                 
                 <h2 class="text-3xl md:text-5xl font-bold font-serif text-white leading-tight tracking-tight mb-4 drop-shadow-md">
                    {mainPost.title}
                 </h2>

                 <div class="flex items-center text-sm font-medium text-slate-300 mt-2 gap-3 opacity-90">
                    <span class="font-bold text-indigo-200">{mainPost.author || 'Noticiencias'}</span>
                    <span class="w-1 h-1 rounded-full bg-slate-400"></span>
                    <span>{getFormattedDate(mainPost.publishDate)}</span>
                 </div>
             </div>
        </div>
      </a>
    </div>
  )}

  {/* Sub Leads (Right, 4 cols, Stacked) */}
  <div class="lg:col-span-4 flex flex-col gap-6">
    {subPostsWithImages.map((post) => (
      <a href={getPermalink(post.permalink, 'post')} class="group relative rounded-xl overflow-hidden bg-white dark:bg-slate-900 shadow-sm border border-border flex flex-row lg:flex-col items-stretch">
        <div class="w-1/3 lg:w-full h-full lg:h-auto lg:aspect-video overflow-hidden relative shrink-0">
            {post.image ? (
                typeof post.image === 'string' ? (
                <img src={post.image} alt={post.title} class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                ) : (
                <Image src={post.image} alt={post.title} width={600} height={400} class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                )
            ) : (
                <div class="w-full h-full bg-surface-highlight"></div>
            )}
        </div>
        <div class="p-4 flex flex-col justify-center flex-1">
            <div class="mb-2">
                {post.category && (
                    <TopicBadge topic={post.category.title} size="sm" />
                )}
            </div>
            <h3 class="text-lg font-bold text-text-heading font-heading leading-tight group-hover:text-primary transition-colors line-clamp-3">
                {post.title}
            </h3>
        </div>
      </a>
    ))}
  </div>
</div>
