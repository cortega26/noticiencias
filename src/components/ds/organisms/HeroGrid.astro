---
import Image from '~/components/template/common/Image.astro';
import TopicBadge from '~/components/ds/atoms/TopicBadge.astro';
import { getPermalink } from '~/utils/permalinks';
import { getFormattedDate } from '~/utils/utils';
import type { Post } from '~/types';

interface Props {
  posts: Post[];
}

const { posts } = Astro.props;

// Ensure we have at least 1 post, ideally 3
const mainPost = posts[0];
const subPosts = posts.slice(1, 3);
---

<div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-12">
  {/* Main Lead Story (Left, 8 cols) - Modern "Cover" Layout */}
  {mainPost && (
    <div class="lg:col-span-8 group relative flex flex-col h-full rounded-2xl overflow-hidden bg-white dark:bg-slate-900 shadow-sm border border-border">
      <a href={getPermalink(mainPost.permalink, 'post')} class="block relative aspect-video lg:aspect-auto lg:flex-1 overflow-hidden">
        {mainPost.image ? (
            typeof mainPost.image === 'string' ? (
                <img 
                  src={mainPost.image as string} 
                  alt={mainPost.title} 
                  class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" 
                  loading="eager"
                  fetchpriority="high"
                />
            ) : (
                <Image 
                  src={mainPost.image} 
                  alt={mainPost.title} 
                  width={1200} 
                  height={800} 
                  class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                  loading="eager"
                  fetchpriority="high"
                  sizes="(max-width: 1024px) 100vw, 800px"
                />
            )
        ) : (
            <div class="w-full h-full bg-surface-highlight flex items-center justify-center">
                <span class="text-gray-300 dark:text-gray-700">Sin Imagen</span>
            </div>
        )}
        <div class="absolute inset-0 bg-gradient-to-t from-gray-900/40 to-transparent pointer-events-none"></div>
      </a>

      <div class="p-6 md:p-8 flex flex-col relative">
         <div class="mb-3">
            {mainPost.category && (
                <TopicBadge topic={mainPost.category.title} />
            )}
         </div>
         
         <h2 class="text-3xl md:text-5xl font-bold font-heading text-text-heading leading-tighter tracking-tighter mb-4 group-hover:text-primary transition-colors">
            <a href={getPermalink(mainPost.permalink, 'post')} class="hover:text-primary transition-colors duration-200">
                {mainPost.title}
            </a>
         </h2>

         <p class="text-lg text-text-muted line-clamp-3 mb-4 hidden md:block">
            {mainPost.excerpt}
         </p>

         <div class="text-sm font-medium text-text-muted mt-auto pt-4 border-t border-border flex items-center">
            <span class="font-bold text-text-default">{mainPost.author || 'Noticiencias'}</span>
            <span class="mx-2">Â·</span>
            {getFormattedDate(mainPost.publishDate)}
         </div>
      </div>
    </div>
  )}

  {/* Sub Leads (Right, 4 cols, Stacked) */}
  <div class="lg:col-span-4 flex flex-col gap-6 h-full">
    {subPosts.map((post) => (
      <a href={getPermalink(post.permalink, 'post')} class="flex-1 group relative rounded-xl overflow-hidden bg-white dark:bg-slate-900 shadow-sm border border-border flex flex-row lg:flex-col items-stretch">
        <div class="w-1/3 lg:w-full h-full lg:h-48 overflow-hidden relative shrink-0">
            {post.image ? (
                typeof post.image === 'string' ? (
                <img src={post.image as string} alt={post.title} class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                ) : (
                <Image src={post.image} alt={post.title} width={600} height={400} class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                )
            ) : (
                <div class="w-full h-full bg-surface-highlight"></div>
            )}
        </div>
        <div class="p-4 flex flex-col justify-center flex-1">
            <div class="mb-2">
                {post.category && (
                    <TopicBadge topic={post.category.title} size="sm" />
                )}
            </div>
            <h3 class="text-lg font-bold text-text-heading font-heading leading-tight group-hover:text-primary transition-colors line-clamp-3">
                {post.title}
            </h3>
        </div>
      </a>
    ))}
  </div>
</div>
